# frozen_string_literal: true

class Malware < ApplicationRecord
  vectorsearch

  after_save :upsert_to_vectorsearch

  has_many :malware_indicators, dependent: :destroy
  has_many :indicators, through: :malware_indicators

  has_many :malware_events, dependent: :destroy
  has_many :events, through: :malware_events

  has_many :malware_malicous_domains, dependent: :destroy
  has_many :malicous_domains, through: :malware_malicous_domains

  has_many :malware_threat_actors, dependent: :destroy
  has_many :threat_actors, through: :malware_threat_actors

  def self.embed!
    find_each do |record|
      record.upsert_to_vectorsearch
      # handle rate limiting to mistral ai
      sleep(5)
    end
  end
end
