class Vulnerability < ApplicationRecord
  vectorsearch

  before_validation :update_details
  after_save :upsert_to_vectorsearch

  has_many :host_vulnerabilities, dependent: :destroy
  has_many :hosts, through: :host_vulnerabilities

  def self.embed!
    find_each do |record|
      record.upsert_to_vectorsearch
      # handle rate limiting to mistral ai
      sleep(1)
    end
  end

  def update_details
    url = "https://raw.githubusercontent.com/olbat/nvdcve/refs/heads/master/nvdcve/#{cve_id}.json"

    req = Faraday.new(url: url) do |req_conn|
      req_conn.response :json
    end

    details = ActiveSupport::JSON.decode(req.get.body)

    desc = details['cve']['description']['description_data'].find do |d|
      d['lang'] == 'en'
    end

    self.description = desc['value'] if desc
    cvss = details['impact']['baseMetricV3']
    cvss = details['impact']['baseMetricV2'] if cvss.nil?
    self.cvss_score = cvss['impactScore']
    self.exploitability_score = cvss['exploitabilityScore']
  end
end
